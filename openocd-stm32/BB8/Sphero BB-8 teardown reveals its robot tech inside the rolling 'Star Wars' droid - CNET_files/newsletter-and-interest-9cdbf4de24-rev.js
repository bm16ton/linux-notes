define(["jquery","managers/page-vars","version!fly/managers/debug","managers/recommendation","managers/recommendation-data","components/urban-airship","managers/client-storage","version!fly/components/base"],function(e,t,n,i,o,a,s){n=n.init("newsletterAndInterest");const r=s.localStorageSupported();e.widget("cnet.newsletterAndInterest",e.fly.base,{interest:null,showNotifications:!0,options:{id:null,name:null,type:null,description:null,ecode:null,isBroadInterest:!1,hasNotifTextHed:"",hasNotifTextDek:""},_create:function(){var n=this;this._setup();var i=t.tracking.data.interest;n.interest={id:n.options.id?n.options.id:i.id,name:n.options.name?n.options.name:i.name,type:n.options.type?n.options.type:i.type,description:n.options.description?n.options.description:i.description,ecode:n.options.ecode?n.options.ecode:i.ecode},window.UA?this._onLoadUrbanAirship():e(window).on("urban-airship-loaded",function(){n._onLoadUrbanAirship()})},_displayFollowInterest:function(){this.$element.removeClass("followedInterest").addClass("nonFollowedInterest")},_updateText:function(e,t){this.$element.find("[data-reengage-"+e+"]").html(t)},_isSafariMweb:function(){var e=window.navigator.userAgent,t=!!e.match(/iPad/i)||!!e.match(/iPhone/i),n=!!e.match(/WebKit/i);return t&&n&&!e.match(/CriOS/i)},_onLoadUrbanAirship:function(){var e=this;window.UA.then(function(t){e.showNotifications=r&&t.canRegister&&!e._isSafariMweb(),e.options.isBroadInterest&&(e.showNotifications?(e._displayFollowInterest(),e.$element.removeClass("noNotifications"),e._updateText("hed",e.options.hasNotifTextHed),e._updateText("dek",e.options.hasNotifTextDek)):e.$element.addClass("noNotifications")),e._setupEvents(t)})},_setupEvents:function(e){var t=this;e.addEventListener("channel",function(n){if("true"!==localStorage.getItem("CnetUdsEnabled")&&t.$element.hasClass("followedInterest")){var a=o.getTagGroupByInterest(t.interest.type);n.channel&&!n.channel.tags.has(t.interest.name.toUpperCase(),a)&&i.addExplicitInterest(e,t.interest)}}),this.$element.on("click","[data-follow-topic]",function(n){if(n.preventDefault(),"checked"===t.$element.find('[name="newsletter_subscribe[checkboxOptionalSignup]"]').attr("checked")){var o=t.$element.find('[data-component="formAjax"]'),s=o.formAjax("option");s.tracking=s.tracking+"-1362879",o.formAjax("option",s)}if(!e.channel||"default"===Notification.permission){a.trackEvent("message","notification|reengagement_unit",!0);let t=Notification.permission;e.register().then(function(n){"default"===e.permission||"default"!==t&&"granted"!==t||a.trackEvent("tap","notification|"+(n.optedIn?"opt-in":"opt-out")+"|reengagement_unit")}).catch(function(){"default"===t&&"denied"===Notification.permission&&airship.trackEvent("tap","notification|opt-out|reengagement_unit")})}r&&e.canRegister&&t.interest&&"none"!==t.interest.id&&i.addExplicitInterest(e,t.interest),t.$element.find("form").submit()})}})});