define(["jquery","version!fly/managers/debug","version!fly/utils/url-helper","managers/events","managers/tealium","managers/page-vars","libs/howler","version!fly/components/base"],function(t,e,i,n,s,a){e=e.init("howlerAudioPlayer"),t.widget("cnet.howlerAudioPlayer",t.fly.base,{options:{url:null,location:null,assetId:null,bucketDir:"https://audio.cnet.com/",eventChannels:null,eventSubscriptions:null,pageUrl:null},$timer:null,sound:null,src:null,isPlaying:!1,initialPlay:!0,percentComplete:0,prevPercentComplete:0,checkpoints:[25,50,75,100],intervalTimer:null,_create:function(){this._setup(),this.options.eventSubscriptions&&n.subscribe(this,this.options.eventSubscriptions),this.$timer=this.$element.find(".timer"),this.src=this.options.url?this.options.url:this.options.location?this.options.bucketDir+this.options.location:this.options.bucketDir+this.options.assetId+"/body.mp3",this._setupAmpIntegration(),this._setupEvents()},_setupEvents:function(){e.log("audioPlayer _setupEvents");var t=this;this.$element.on("click",function(){t.isPlaying?t.pause():t.isLoaded()?t.play():t._setupAudio()})},_setupAudio:function(){e.log("audioPlayer _setupAudio");var t=this;t.sound=new Howl({src:[t.src],format:["mp3"],html5:!0,volume:.5,onplayerror:function(){t.sound.once("unlock",function(){t.play()})},onload:function(){t.play()},onend:function(){t._reset()}})},play:function(){e.log("Play player");var t=this;!this.isPlaying&&this.isLoaded()&&(this.initialPlay?(this._trackCustomEvent("audio-button|initial-play"),this.initialPlay=!1):this._trackCustomEvent("audio-button|play"),this.options.eventChannels&&n.publish(this.options.eventChannels,"playAudio"),this.sound.play(),this.isPlaying=!0,this.$element.addClass("isPlaying"),this.intervalTimer=setInterval(function(){t._updateTimer()},1e3))},pause:function(){e.log("Pause player"),this.isPlaying&&this.isLoaded()&&(this._trackCustomEvent("audio-button|pause"),this.options.eventChannels&&n.publish(this.options.eventChannels,"pauseAudio"),this.sound.pause(),this.isPlaying=!1,this.$element.removeClass("isPlaying"),clearInterval(this.intervalTimer))},_reset:function(){e.log("Reset player"),this.options.eventChannels&&n.publish(this.options.eventChannels,"resetAudio"),this.isLoaded()&&0!=this.sound.seek()&&this.sound.stop(),this.isPlaying=!1,this.$element.removeClass("isPlaying"),clearInterval(this.intervalTimer),this._updateTimer(this.sound.duration())},_updateTimer:function(t=null){var e=t||this.sound.seek();for(var i in this.percentComplete=Math.floor(e/this.sound.duration()*100),this.checkpoints)if(this.percentComplete>=this.checkpoints[i]&&this.prevPercentComplete<this.checkpoints[i]){this._trackCustomEvent("audio-button|progress|"+this.checkpoints[i]);break}this.prevPercentComplete=this.percentComplete;var n=t||this.sound.duration()-e;this.$timer.text(" - "+this._formatTimer(n))},_formatTimer:function(t){t=!isNaN(parseInt(t))&&t>0?t:0;var e=new Date(null);return e.setSeconds(t),e.toISOString().substr(14,5)},isLoaded:function(){return this.sound&&"loaded"===this.sound.state()},isLoadedEvent:function(){this.isLoaded()&&this.options.eventChannels&&n.publish(this.options.eventChannels,"audioLoaded")},_setupAmpIntegration:function(){e.log("audioPlayer _setupAmpIntegration");try{-1===window.location.hash.indexOf("amp=1")&&-1===window.location.hash.indexOf("ampreview=1")||(this.options.pageUrl=i.getHashParam("pageUrl")?decodeURIComponent(i.getHashParam("pageUrl")):null)}catch(t){e.error("Failed to set page params: ",t)}},_trackCustomEvent:function(t){e.log("Track Event: "+t),trackingData=a.tracking.data,s.trackCustomEvent("trackAudioPlayer",{siteSection:trackingData.siteSection,siteEdition:trackingData.siteEdition,siteType:trackingData.siteType,deviceType:trackingData.deviceType,siteHier:trackingData.siteHier,pageUrl:this.options.pageUrl||trackingData._pageUrl,pageType:trackingData.pageType,articleTitle:trackingData.articleTitle,articleType:trackingData.articleType,topicId:trackingData.topicId,pageViewGuid:trackingData.pageViewGuid,collectionId:trackingData.collectionId,articleId:trackingData.articleId,_dwAnonId:trackingData._dwAnonId,pageComponents:trackingData.pageComponents,clickGenericText:t},"trackClick")}})});